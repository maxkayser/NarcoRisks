<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NarkoSafe</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
    h2 { margin-top: 0; }
    label { display: block; margin: 0.5rem 0; }
    textarea { width: 100%; height: 120px; }
    .category { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>NarkoSafe</h1>

  <section>
    <h2>Patient / Eingriff</h2>
    <label><input type="checkbox" id="elective" checked /> Elektiveingriff</label>
    <label><input type="checkbox" id="adult" checked /> Volljährig</label>
    <label>Sorgeberechtiger: <input type="text" id="guardianName" /></label>
    <label>Eingriff:
      <select id="procedure">
        <option value="">-- bitte wählen --</option>
        <option value="knee">Knie-OP</option>
        <option value="thyroid">Schilddrüsen-OP</option>
      </select>
    </label>
    <label>Lagerung:
      <select id="position">
        <option value="">-- bitte wählen --</option>
        <option value="ruecken">Rücken</option>
        <option value="bauch">Bauch</option>
        <option value="beachchair">Beachchair</option>
      </select>
    </label>
    <label><input type="checkbox" id="allergy" /> Allergie</label>
    <label>Sprache:
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="en">Englisch</option>
        <option value="fr">Französisch</option>
      </select>
    </label>
  </section>

  <section>
    <h2>Risiken</h2>
    <div id="risksOutput">Lade Risiken...</div>
  </section>

  <section>
    <h2>Zusammenfassung</h2>
    <label>Zusätzlicher Text:
      <textarea id="additionalText">Der Patient bestätigt auf Nachfrage alles verstanden zu haben, keinen weiteren offenen Fragen zu haben. Der Patient wünscht ausdrücklich die Durchführung der Maßnahmen unter den genannten Risiken. Eine Kopie dieses Dokuments wurde angeboten.</textarea>
    </label>
    <button onclick="generateSummary()">Zusammenfassung erstellen</button>
    <textarea id="summaryText" readonly></textarea>
  </section>

<script>
  const risksUrl = 'https://raw.githubusercontent.com/maxkayser/NarkoSafe/a7c7a3db77bb45a66d8e581d2f4ce9edf102bdf4/data/risks.json';
  let allRisks = [];

  async function loadRisks() {
    try {
      const response = await fetch(risksUrl);
      const data = await response.json();
      const rawRoot = data.risks.children[0];
      allRisks = Object.entries(rawRoot)
        .filter(([k, v]) => typeof v === 'object' && v.label)
        .map(([key, value]) => ({
          key,
          label: value.label,
          entries: Object.entries(value).filter(([k]) => k !== 'label')
        }));
      renderRiskGroups();
    } catch (error) {
      document.getElementById('risksOutput').innerText = 'Fehler beim Laden der Risiken.';
      console.error(error);
    }
  }

  function renderRiskGroups() {
    const lang = document.getElementById('language').value || 'de';
    const output = document.getElementById('risksOutput');
    output.innerHTML = '';

    for (const group of allRisks) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'category';
      groupDiv.textContent = group.label?.[lang] || group.key;
      output.appendChild(groupDiv);

      for (const [childKey, childValue] of group.entries) {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'riskSubgroups';
        checkbox.value = group.key + '.' + childKey;
        checkbox.addEventListener('change', generateSummary);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + (childValue.label?.[lang] || childKey)));
        output.appendChild(label);
      }
    }
    generateSummary();
  }

  function generateSummary() {
    const lang = document.getElementById('language').value || 'de';
    const selectedKeys = Array.from(document.querySelectorAll('input[name="riskSubgroups"]:checked')).map(el => el.value);
    const result = [];

    for (const path of selectedKeys) {
      const [groupKey, childKey] = path.split('.');
      const group = allRisks.find(g => g.key === groupKey);
      const child = group?.entries.find(([k]) => k === childKey);
      const labelText = child?.[1].label?.[lang] || childKey;
      result.push(labelText);
    }

    const additional = document.getElementById('additionalText').value;
    document.getElementById('summaryText').value = result.join('\n\n') + '\n\n' + additional;
  }

  document.getElementById('language').addEventListener('change', renderRiskGroups);
  document.getElementById('additionalText').addEventListener('input', generateSummary);
  window.onload = loadRisks;
</script>
</body>
</html>
