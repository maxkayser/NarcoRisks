<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NarcoRisks - Risikoaufklärung</title> 
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
    h2 { margin-top: 0; }
    label { display: block; margin: 0.5rem 0; }
    textarea { width: 100%; height: 120px; }
    .category { margin-top: 1rem; font-weight: bold; cursor: pointer; }
    .subcategory { margin-left: 1rem; display: none; }
    .toggle::before { content: '\25BA'; display: inline-block; margin-right: 5px; }
    .expanded.toggle::before { content: '\25BC'; }
    .subgroup-toggle { cursor: pointer; margin: 0.5rem 0; }
    #summaryText {
      font-family: Calibri, Arial, sans-serif;
      font-size: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

<style>
  #copyButton {
    background-color: #3c7dd9;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
  }
  #copyButton:hover {
    background-color: #2f66b3;
  }
</style>

</style>

</head>
<body>
  <h1>NarcoRisks</h1>

  <section>
    <!--<h2>Patient / Eingriff</h2>-->
    <label>Sprache:
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="en">Englisch</option>
        <option value="fr">Französisch</option>
      </select>
<div id="staticTextblockCheckboxes" style="margin-top:1em;"></div>
<div id="textblockToggles"></div>

    </label>
    <!--
    <label><input type="checkbox" id="elective" checked /> Elektiveingriff</label>
    <label><input type="checkbox" id="adult" checked /> Volljährig</label>
    <label>Sorgeberechtiger: <input type="text" id="guardianName" /></label>
    <label>Eingriff:
      <select id="procedure">
        <option value="">-- bitte wählen --</option>
        <option value="knee">Knie-OP</option>
        <option value="thyroid">Schilddrüsen-OP</option>
      </select>
    </label>
    <label>Lagerung:
      <select id="position">
        <option value="">-- bitte wählen --</option>
        <option value="ruecken">Rücken</option>
        <option value="bauch">Bauch</option>
        <option value="beachchair">Beachchair</option>
      </select>
    </label>
    <label><input type="checkbox" id="allergy" /> Allergie</label>
    -->
  </section>

  <section>
    <h2 id="risksTitle">Risiken</h2>
    <div id="risksOutput">Lade Risiken...</div>
    <br>
    <label>
      <textarea id="additionalText" style="height: 40px;" placeholder="Zusätzlicher Text..."></textarea>
    </label>
  </section>

  <section>
    <h2>Zusammenfassung</h2>
    <!--<button onclick="generateSummary()">Zusammenfassung erstellen</button>-->
    <textarea id="summaryText" readonly></textarea>
    <button onclick="copyToClipboard()">In Zwischenablage kopieren</button>

  </section>

<script>
  const risksUrl = 'https://raw.githubusercontent.com/maxkayser/NarkoSafe/main/data/risks.json';
  let allRisks = [];

  function copyToClipboard() {
    const summary = document.getElementById("summaryText");
    summary.select();
    summary.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Text wurde in die Zwischenablage kopiert.");
  }

  async function loadRisks() {
    try {
      const response = await fetch(risksUrl);
      const data = await response.json();
      textblocks = data.textblocks || {};
      console.log('[loadRisks] textblocks loaded', textblocks);
      renderTextblockToggles();
      renderStaticTextblockCheckboxes();
      const rawRoot = data.risks.children[0];
      allRisks = Object.entries(rawRoot)
        .filter(([k, v]) => typeof v === 'object' && v.label)
        .map(([key, value]) => ({
          key,
          label: value.label,
          entries: [
            ...Object.entries(value).filter(([k]) => k === 'common'),
            ...Object.entries(value).filter(([k]) => k !== 'label' && k !== 'common')
          ]
        }));
      const defaults = data.defaults || {};
      renderRiskGroups(defaults);
    } catch (error) {
      document.getElementById('risksOutput').innerText = 'Fehler beim Laden der Risiken.';
      console.error(error);
    }
  }

  function activateCommonItems(groupKey, entriesContainer) {
    const commonItems = entriesContainer.querySelectorAll(`input[value^="${groupKey}.common."]`);
    const anyChecked = Array.from(commonItems).some(cb => cb.checked);
    if (!anyChecked) {
      commonItems.forEach(cb => {
        cb.checked = true;
        console.log(`[activateCommonItems] aktiviert: ${cb.value}`);
      });
    } else {
      console.log(`[activateCommonItems] bereits aktiviert: ${groupKey}.common.*`);
    }

    const commonGroupCheckbox = entriesContainer.querySelector(`input[type="checkbox"][value="${groupKey}.common"]`);
    if (commonGroupCheckbox && !commonGroupCheckbox.checked) {
      commonGroupCheckbox.checked = true;
      console.log(`[activateCommonItems] Gruppe „common“ Checkbox gesetzt: ${groupKey}.common`);
    }
  }

  function deactivateCommonIfUnused(groupKey, entriesContainer) {
    const nonCommon = entriesContainer.querySelectorAll(`input[value^="${groupKey}.\"]:not([value^="${groupKey}.common"])`);
    const anyChecked = Array.from(nonCommon).some(cb => cb.checked);
    if (!anyChecked) {
      const commonBox = entriesContainer.querySelector(`input[type="checkbox"][value="${groupKey}.common"]`);
      if (commonBox) {
        commonBox.checked = false;
        console.log(`[deactivateCommonIfUnused] Subgroup Checkbox deaktiviert: ${groupKey}.common`);
      }
      const commonItems = entriesContainer.querySelectorAll(`input[value^="${groupKey}.common."]`);
      commonItems.forEach(cb => {
        if (cb.checked) {
          cb.checked = false;
          console.log(`[deactivateCommonIfUnused] deaktiviert: ${cb.value}`);
        }
      });
    }
  }

  function renderRiskGroups(defaults = {}) {
    const lang = document.getElementById('language').value || 'de';
    const output = document.getElementById('risksOutput');
    output.innerHTML = '';

    for (const group of allRisks) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'category toggle expanded';
      groupDiv.textContent = group.label?.[lang] || group.key;
      output.appendChild(groupDiv);

      const entriesContainer = document.createElement('div');
      entriesContainer.className = 'subcategory';
      entriesContainer.style.display = 'block';
      output.appendChild(entriesContainer);

      groupDiv.addEventListener('click', () => {
        entriesContainer.style.display = entriesContainer.style.display === 'none' ? 'block' : 'none';
        groupDiv.classList.toggle('expanded');
      });

      for (const [subKey, subValue] of group.entries) {
        const sublabel = subValue.label?.[lang] || subKey;

        if (typeof subValue === 'object' && subValue.label && Object.values(subValue).some(val => val.label)) {
          const subgroupHeader = document.createElement('div');
          subgroupHeader.className = 'subgroup-toggle';

          const subgroupCheckbox = document.createElement('input');
          subgroupCheckbox.type = 'checkbox';
          subgroupCheckbox.value = `${group.key}.${subKey}`;
          subgroupCheckbox.style.marginRight = '0.5rem';

          const subgroupContainer = document.createElement('div');
          subgroupContainer.className = 'subcategory';

          subgroupCheckbox.addEventListener('change', () => {
            const checked = subgroupCheckbox.checked;
            const subInputs = subgroupContainer.querySelectorAll('input[type=checkbox]');
            subInputs.forEach(cb => cb.checked = checked);
            if (checked && subKey !== 'common') {
              activateCommonItems(group.key, entriesContainer);
            } else {
              deactivateCommonIfUnused(group.key, entriesContainer);
            }
            generateSummary();
          });

          subgroupHeader.appendChild(subgroupCheckbox);
          subgroupHeader.appendChild(document.createTextNode(sublabel));
          entriesContainer.appendChild(subgroupHeader);
          entriesContainer.appendChild(subgroupContainer);

          subgroupHeader.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'input') {
              subgroupContainer.style.display = subgroupContainer.style.display === 'none' ? 'block' : 'none';
              subgroupHeader.classList.toggle('expanded');
            }
          });

          const pathSub = `risks.${group.key}.${subKey}`;
          const groupPath = `risks.${group.key}`;
          let activateAllLeafs = false;

          for (const [leafKey, leafValue] of Object.entries(subValue)) {
            if (leafKey === 'label') continue;
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'riskSubgroups';
            checkbox.value = `${group.key}.${subKey}.${leafKey}`;
            const pathLeaf = `risks.${group.key}.${subKey}.${leafKey}`;
            if (defaults[pathLeaf] || defaults[groupPath]) {
              console.log(`[defaults] aktiviert: ${defaults[pathLeaf] ? pathLeaf : groupPath}`);
              checkbox.checked = true;
              if (subKey !== 'common') activateCommonItems(group.key, entriesContainer);
            }
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + (leafValue.label?.[lang] || leafKey)));
            subgroupContainer.appendChild(label);
          }

          // ⚠️ Jetzt nach Erzeugung aller Leafs: Subgruppen-Default?
          if (defaults[pathSub]) {
            console.log(`[defaults] aktiviert: ${pathSub}`);
            subgroupCheckbox.checked = true;
            const leafCheckboxes = subgroupContainer.querySelectorAll('input[type=checkbox]');
            leafCheckboxes.forEach(cb => {
              if (!cb.checked) {
                cb.checked = true;
                console.log(`[defaults] mitaktiviert: ${cb.value}`);
              }
            });
            if (subKey !== 'common') activateCommonItems(group.key, entriesContainer);
          }

        } else {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'riskSubgroups';
          checkbox.value = `${group.key}.${subKey}`;
          const path = `risks.${group.key}.${subKey}`;
          const groupPath = `risks.${group.key}`;
          if (defaults[path] || defaults[groupPath]) {
            console.log(`[defaults] aktiviert: ${defaults[path] ? path : groupPath}`);
            checkbox.checked = true;
            if (subKey !== 'common') activateCommonItems(group.key, entriesContainer);
          }
          checkbox.addEventListener('change', (e) => {
            if (e.target.checked && subKey !== 'common') {
              activateCommonItems(group.key, entriesContainer);
            } else {
              deactivateCommonIfUnused(group.key, entriesContainer);
            }
            generateSummary();
          });
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(' ' + sublabel));
          entriesContainer.appendChild(label);
        }
      }
    }
    generateSummary();
  }

  function generateSummary() {
    const lang = document.getElementById('language').value || 'de';
    const selectedKeys = Array.from(document.querySelectorAll('input[name="riskSubgroups"]:checked')).map(el => el.value);
    const grouped = {};

    for (const path of selectedKeys) {
      const keys = path.split('.');
      const group = allRisks.find(g => g.key === keys[0]);
      if (!group) continue;
      const groupLabel = group.label?.[lang] || keys[0];
      let subgroupLabel = '';
      let riskLabel = '';

      if (keys.length === 2) {
        const entry = group.entries.find(([k]) => k === keys[1]);
        subgroupLabel = entry?.[1]?.label?.[lang] || keys[1];
        riskLabel = subgroupLabel;
      } else if (keys.length === 3) {
        const entry = group.entries.find(([k]) => k === keys[1]);
        subgroupLabel = entry?.[1]?.label?.[lang] || keys[1];
        const child = entry?.[1]?.[keys[2]];
        riskLabel = child?.label?.[lang] || keys[2];
      }

      if (!grouped[groupLabel]) grouped[groupLabel] = {};
      if (!grouped[groupLabel][subgroupLabel]) grouped[groupLabel][subgroupLabel] = [];
      grouped[groupLabel][subgroupLabel].push(riskLabel);
    }

    const intro = 'Im Rahmen der präoperativen anästhesiologischen Visite wurden die folgenden Risiken unter Berücksichtigung des individuellen Kontextes ausführlich besprochen:';
    const additional = document.getElementById('additionalText')?.value || '';

    let result = '';
    for (const [groupLabel, subgroups] of Object.entries(grouped)) {
      result += `\n\n${groupLabel}\n`;
      for (const [subLabel, risks] of Object.entries(subgroups)) {
        result += `${subLabel}: ${risks.join(', ')}\n`;
      }
    }

    document.getElementById('summaryText').value = `${intro}${result}\n\n${additional}`;
  }

  document.getElementById('language').addEventListener('change', () => {
    document.getElementById('risksTitle').textContent = {
      de: 'Risiken',
      en: 'Risks',
      fr: 'Risques'
    }[document.getElementById('language').value] || 'Risiken';
    renderRiskGroups();
  });

  document.getElementById('additionalText').addEventListener('input', generateSummary);
  window.onload = loadRisks;

function renderTextblockToggles() {
  const container = document.getElementById('textblockToggles');
  if (!container || !textblocks) return;
  const lang = document.getElementById('language').value || 'de';
  container.innerHTML = '';
  Object.keys(textblocks).forEach(key => {
    if (key === 'intro' || key === 'closing') return;
    const label = textblocks[key]?.label?.[lang] || key;
    const wrapper = document.createElement('label');
    wrapper.style.display = 'block';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'textblock';
    checkbox.value = key;
    checkbox.addEventListener('change', generateSummary);
    wrapper.appendChild(checkbox);
    wrapper.appendChild(document.createTextNode(' ' + label));
    container.appendChild(wrapper);
  });
}

function generateSummary() {
  const lang = document.getElementById('language').value || 'de';
  const selectedKeys = Array.from(document.querySelectorAll('input[name="riskSubgroups"]:checked')).map(el => el.value);
  const grouped = {};

  for (const path of selectedKeys) {
    const keys = path.split('.');
    const group = allRisks.find(g => g.key === keys[0]);
    if (!group) continue;
    const groupLabel = group.label?.[lang] || keys[0];
    let subgroupLabel = '';
    let riskLabel = '';

    if (keys.length === 2) {
      const entry = group.entries.find(([k]) => k === keys[1]);
      subgroupLabel = entry?.[1]?.label?.[lang] || keys[1];
      riskLabel = subgroupLabel;
    } else if (keys.length === 3) {
      const entry = group.entries.find(([k]) => k === keys[1]);
      subgroupLabel = entry?.[1]?.label?.[lang] || keys[1];
      const child = entry?.[1]?.[keys[2]];
      riskLabel = child?.label?.[lang] || keys[2];
    }

    if (!grouped[groupLabel]) grouped[groupLabel] = {};
    if (!grouped[groupLabel][subgroupLabel]) grouped[groupLabel][subgroupLabel] = [];
    grouped[groupLabel][subgroupLabel].push(riskLabel);
  }

  const intro = textblocks?.intro?.[lang] || '';
  const closing = textblocks?.closing?.[lang] || '';
  const additional = document.getElementById('additionalText')?.value || '';
  const selectedTextblocks = Array.from(document.querySelectorAll('input[name="textblock"]:checked')).map(cb => cb.value);

  let result = intro ? intro + '\n\n' : '';

  for (const [groupLabel, subgroups] of Object.entries(grouped)) {
    result += `${groupLabel}\n`;
    for (const [subLabel, risks] of Object.entries(subgroups)) {
      result += `${subLabel}: ${risks.join(', ')}\n`;
    }
    result += '\n';
  }

  for (const key of selectedTextblocks) {
    const text = textblocks?.[key]?.[lang];
    if (text) result += `\n${text}\n`;
  }

  if (additional.trim()) {
    result += `\n${additional}\n`;
  }

  if (closing.trim()) {
    result += `\n${closing}`;
  }

  document.getElementById('summaryText').value = result.trim();
}

document.getElementById('language').addEventListener('change', () => {
  document.getElementById('risksTitle').textContent = {
    de: 'Risiken',
    en: 'Risks',
    fr: 'Risques'
  }[document.getElementById('language').value] || 'Risiken';
  renderRiskGroups();
  renderTextblockToggles();
});


function renderStaticTextblockCheckboxes() {
  console.log('[renderStaticTextblockCheckboxes] called');
  const lang = document.getElementById('language').value || 'de';
  const container = document.getElementById('staticTextblockCheckboxes');
  container.innerHTML = '';

  const blocks = [];

  blocks.forEach(item => {
    const wrapper = document.createElement('label');
    wrapper.style.display = 'block';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'textblock';
    checkbox.value = item.key;
    checkbox.addEventListener('change', generateSummary);
    wrapper.appendChild(checkbox);
    wrapper.appendChild(document.createTextNode(' ' + (item.label[lang] || item.key)));
    container.appendChild(wrapper);
  });
}

</script>
<div id="textblockToggles" style="display: none"></div>
<span>&copy; 2025 Max Kayser</span>
</body>
</html>
