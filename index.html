<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NarkoSafe</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
    h2 { margin-top: 0; }
    label { display: block; margin: 0.5rem 0; }
    textarea { width: 100%; height: 120px; }
    .category { margin-top: 1rem; font-weight: bold; cursor: pointer; }
    .subcategory { margin-left: 1rem; display: none; }
    .toggle::before { content: '\25BA'; display: inline-block; margin-right: 5px; }
    .expanded.toggle::before { content: '\25BC'; }
    .subgroup-toggle { cursor: pointer; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h1>NarkoSafe</h1>

  <section>
    <h2>Patient / Eingriff</h2>
    <label><input type="checkbox" id="elective" checked /> Elektiveingriff</label>
    <label><input type="checkbox" id="adult" checked /> Volljährig</label>
    <label>Sorgeberechtiger: <input type="text" id="guardianName" /></label>
    <label>Eingriff:
      <select id="procedure">
        <option value="">-- bitte wählen --</option>
        <option value="knee">Knie-OP</option>
        <option value="thyroid">Schilddrüsen-OP</option>
      </select>
    </label>
    <label>Lagerung:
      <select id="position">
        <option value="">-- bitte wählen --</option>
        <option value="ruecken">Rücken</option>
        <option value="bauch">Bauch</option>
        <option value="beachchair">Beachchair</option>
      </select>
    </label>
    <label><input type="checkbox" id="allergy" /> Allergie</label>
    <label>Sprache:
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="en">Englisch</option>
        <option value="fr">Französisch</option>
      </select>
    </label>
  </section>

  <section>
    <h2 id="risksTitle">Risiken</h2>
    <div id="risksOutput">Lade Risiken...</div>
  </section>

  <section>
    <h2>Zusammenfassung</h2>
    <label>Zusätzlicher Text:
      <textarea id="additionalText">Der Patient bestätigt auf Nachfrage alles verstanden zu haben, keinen weiteren offenen Fragen zu haben. Der Patient wünscht ausdrücklich die Durchführung der Maßnahmen unter den genannten Risiken. Eine Kopie dieses Dokuments wurde angeboten.</textarea>
    </label>
    <button onclick="generateSummary()">Zusammenfassung erstellen</button>
    <textarea id="summaryText" readonly></textarea>
  </section>

<script>
  const risksUrl = 'https://raw.githubusercontent.com/maxkayser/NarkoSafe/main/data/risks.json';
  let allRisks = [];

  async function loadRisks() {
    try {
      const response = await fetch(risksUrl);
      const data = await response.json();
      const rawRoot = data.risks.children[0];
      allRisks = Object.entries(rawRoot)
        .filter(([k, v]) => typeof v === 'object' && v.label)
        .map(([key, value]) => ({
          key,
          label: value.label,
          entries: Object.entries(value).filter(([k]) => k !== 'label')
        }));
      renderRiskGroups();
    } catch (error) {
      document.getElementById('risksOutput').innerText = 'Fehler beim Laden der Risiken.';
      console.error(error);
    }
  }

  function renderRiskGroups() {
    const lang = document.getElementById('language').value || 'de';
    const output = document.getElementById('risksOutput');
    output.innerHTML = '';

    for (const group of allRisks) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'category toggle expanded';
      groupDiv.textContent = group.label?.[lang] || group.key;
      output.appendChild(groupDiv);

      const entriesContainer = document.createElement('div');
      entriesContainer.className = 'subcategory';
      entriesContainer.style.display = 'block';
      output.appendChild(entriesContainer);

      groupDiv.addEventListener('click', () => {
        entriesContainer.style.display = entriesContainer.style.display === 'none' ? 'block' : 'none';
        groupDiv.classList.toggle('expanded');
      });

      for (const [subKey, subValue] of group.entries) {
        const sublabel = subValue.label?.[lang] || subKey;

        if (typeof subValue === 'object' && subValue.label && Object.values(subValue).some(val => val.label)) {
          const subgroupHeader = document.createElement('div');
          subgroupHeader.className = 'subgroup-toggle';

          const subgroupCheckbox = document.createElement('input');
          subgroupCheckbox.type = 'checkbox';
          subgroupCheckbox.style.marginRight = '0.5rem';
          subgroupCheckbox.addEventListener('change', () => {
            const subInputs = subgroupContainer.querySelectorAll('input[type=checkbox]');
            subInputs.forEach(cb => cb.checked = subgroupCheckbox.checked);
            generateSummary();
          });

          subgroupHeader.appendChild(subgroupCheckbox);
          subgroupHeader.appendChild(document.createTextNode(sublabel));

          const subgroupContainer = document.createElement('div');
          subgroupContainer.className = 'subcategory';

          entriesContainer.appendChild(subgroupHeader);
          entriesContainer.appendChild(subgroupContainer);

          subgroupHeader.addEventListener('click', (e) => {
            if (e.target.tagName.toLowerCase() !== 'input') {
              subgroupContainer.style.display = subgroupContainer.style.display === 'none' ? 'block' : 'none';
              subgroupHeader.classList.toggle('expanded');
            }
          });

          for (const [leafKey, leafValue] of Object.entries(subValue)) {
            if (leafKey === 'label') continue;
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'riskSubgroups';
            checkbox.value = group.key + '.' + subKey + '.' + leafKey;
            checkbox.addEventListener('change', generateSummary);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + (leafValue.label?.[lang] || leafKey)));
            subgroupContainer.appendChild(label);
          }
        } else {
          const label = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'riskSubgroups';
          checkbox.value = group.key + '.' + subKey;
          checkbox.addEventListener('change', generateSummary);
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(' ' + sublabel));
          entriesContainer.appendChild(label);
        }
      }
    }
    generateSummary();
  }

  function generateSummary() {
    const lang = document.getElementById('language').value || 'de';
    const selectedKeys = Array.from(document.querySelectorAll('input[name="riskSubgroups"]:checked')).map(el => el.value);
    const grouped = {};

    for (const path of selectedKeys) {
      const keys = path.split('.');
      const group = allRisks.find(g => g.key === keys[0]);
      if (!group) continue;
      const groupLabel = group.label?.[lang] || keys[0];
      let subgroupLabel = '';
      let riskLabel = '';

      if (keys.length === 2) {
        const entry = group.entries.find(([k]) => k === keys[1]);
        subgroupLabel = groupLabel;
        riskLabel = entry?.[1]?.label?.[lang] || keys[1];
      } else if (keys.length === 3) {
        const entry = group.entries.find(([k]) => k === keys[1]);
        subgroupLabel = entry?.[1]?.label?.[lang] || keys[1];
        const child = entry?.[1]?.[keys[2]];
        riskLabel = child?.label?.[lang] || keys[2];
      }

      if (!grouped[subgroupLabel]) grouped[subgroupLabel] = [];
      grouped[subgroupLabel].push(riskLabel);
    }

    let result = Object.entries(grouped)
      .map(([subgroup, risks]) => `${subgroup}: ${risks.join(', ')}`)
      .join('\n\n');

    const additional = document.getElementById('additionalText').value;
    document.getElementById('summaryText').value = result + '\n\n' + additional;
  }

  document.getElementById('language').addEventListener('change', () => {
    document.getElementById('risksTitle').textContent = {
      de: 'Risiken',
      en: 'Risks',
      fr: 'Risques'
    }[document.getElementById('language').value] || 'Risiken';
    renderRiskGroups();
  });

  document.getElementById('additionalText').addEventListener('input', generateSummary);
  window.onload = loadRisks;
</script>
</body>
</html>
