<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NarkoSafe</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
    h2 { margin-top: 0; }
    label { display: block; margin: 0.5rem 0; }
    textarea { width: 100%; height: 120px; }
    .category { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>NarkoSafe</h1>

  <section>
    <h2>Patient / Eingriff</h2>
    <label><input type="checkbox" id="elective" checked /> Elektiveingriff</label>
    <label><input type="checkbox" id="adult" checked /> Volljährig</label>
    <label>Sorgeberechtiger: <input type="text" id="guardianName" /></label>
    <label>Eingriff:
      <select id="procedure">
        <option value="">-- bitte wählen --</option>
        <option value="knee">Knie-OP</option>
        <option value="thyroid">Schilddrüsen-OP</option>
      </select>
    </label>
    <label>Lagerung:
      <select id="position">
        <option value="">-- bitte wählen --</option>
        <option value="ruecken">Rücken</option>
        <option value="bauch">Bauch</option>
        <option value="beachchair">Beachchair</option>
      </select>
    </label>
    <label><input type="checkbox" id="allergy" /> Allergie</label>
    <label>Sprache:
      <select id="language">
        <option value="de">Deutsch</option>
        <option value="en">Englisch</option>
        <option value="fr">Französisch</option>
      </select>
    </label>
  </section>

  <section>
    <h2>Risiken</h2>
    <div id="risksOutput">Lade Risiken...</div>
  </section>

  <section>
    <h2>Zusammenfassung</h2>
    <label>Zusätzlicher Text:
      <textarea id="additionalText">Der Patient bestätigt auf Nachfrage alles verstanden zu haben, keinen weiteren offenen Fragen zu haben. Der Patient wünscht ausdrücklich die Durchführung der Maßnahmen unter den genannten Risiken. Eine Kopie dieses Dokuments wurde angeboten.</textarea>
    </label>
    <button onclick="generateSummary()">Zusammenfassung erstellen</button>
    <textarea id="summaryText" readonly></textarea>
  </section>

<script>
  const risksUrl = 'https://raw.githubusercontent.com/maxkayser/NarkoSafe/bcc90b22e4dd78f34f4076c21aa0100d5701355e/data/risks.json';
  let allRisks = {};

  async function loadRisks() {
    try {
      const response = await fetch(risksUrl);
      const data = await response.json();
      allRisks = data.risks_catalog || data;
      renderRiskGroups();
    } catch (error) {
      document.getElementById('risksOutput').innerText = 'Fehler beim Laden der Risiken.';
      console.error(error);
    }
  }

  function renderRiskGroups() {
    const lang = document.getElementById('language').value || 'de';
    const output = document.getElementById('risksOutput');
    output.innerHTML = '';

    for (const groupKey in allRisks) {
      const groupData = allRisks[groupKey];
      const groupDiv = document.createElement('div');
      groupDiv.className = 'category';
      groupDiv.textContent = groupKey.replace(/_/g, ' ').toUpperCase();
      output.appendChild(groupDiv);

      for (const subKey in groupData) {
        if (typeof groupData[subKey] === 'object' && !groupData[subKey][lang]) {
          // nested sub-category
          const subLabel = document.createElement('label');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'riskSubgroups';
          checkbox.value = `${groupKey}.${subKey}`;
          subLabel.appendChild(checkbox);
          subLabel.appendChild(document.createTextNode(' ' + subKey.replace(/_/g, ' ')));
          output.appendChild(subLabel);
        } else {
          // flat risk category (e.g., general risks)
          const flatLabel = document.createElement('label');
          const flatCheckbox = document.createElement('input');
          flatCheckbox.type = 'checkbox';
          flatCheckbox.name = 'riskSubgroups';
          flatCheckbox.value = `${groupKey}`;
          flatLabel.appendChild(flatCheckbox);
          flatLabel.appendChild(document.createTextNode(' ' + groupKey.replace(/_/g, ' ')));
          output.appendChild(flatLabel);
          break; // only once
        }
      }
    }
  }

  function generateSummary() {
    const lang = document.getElementById('language').value || 'de';
    const selectedKeys = Array.from(document.querySelectorAll('input[name="riskSubgroups"]:checked')).map(el => el.value);

    const result = [];

    for (const path of selectedKeys) {
      const parts = path.split('.');
      let ref = allRisks;

      // navigate into JSON structure
      for (const part of parts) {
        if (ref[part]) {
          ref = ref[part];
        }
      }

      const risks = [];
      function extractTexts(obj) {
        for (const key in obj) {
          if (typeof obj[key] === 'object' && obj[key][lang]) {
            risks.push(obj[key][lang]);
          } else if (typeof obj[key] === 'object') {
            extractTexts(obj[key]);
          }
        }
      }
      extractTexts(ref);

      const title = parts.join(' / ').replace(/_/g, ' ');
      result.push(`${title}: ${risks.join(', ')}`);
    }

    const additional = document.getElementById('additionalText').value;
    document.getElementById('summaryText').value = result.join('\n\n') + '\n\n' + additional;
  }

  document.getElementById('language').addEventListener('change', renderRiskGroups);
  window.onload = loadRisks;
</script>

</body>
</html>
